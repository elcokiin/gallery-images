# docker-compose.yml
version: '3.8' # Especifica la versión de Docker Compose

# Define los servicios (contenedores) que componen tu aplicación
services:
  # Servicio de Prometheus
  prometheus:
    image: prom/prometheus # Usa la imagen oficial de Prometheus
    container_name: my-prometheus
    ports:
      - "9090:9090" # Mapea el puerto 9090 del host al puerto 9090 del contenedor (UI de Prometheus)
    volumes:
      # Monta nuestro archivo de configuración local en la ubicación correcta dentro del contenedor
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      # Monta un volumen con nombre para la persistencia de datos de Prometheus
      - prometheus_data:/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml # Le dice a Prometheus qué configuración usar
    networks:
      - monitoring-network

  # Servicio de Grafana
  grafana:
    image: grafana/grafana # Usa la imagen oficial de Grafana
    container_name: my-grafana
    ports:
      - "3001:3000" # Mapea el puerto 3001 del host al puerto 3000 del contenedor (UI de Grafana)
    volumes:
      # Monta un volumen con nombre para la persistencia de datos de Grafana
      - grafana_data:/var/lib/grafana
      # Opcional: Puedes montar dashboards y configuraciones personalizadas aquí
    networks:
      - monitoring-network
    depends_on:
      - prometheus # Asegura que Prometheus inicie antes que Grafana

  node-exporter:
    # Nuevo servicio para monitorear el sistema operativo del host
    image: prom/node-exporter:latest # Usa la imagen oficial de Node Exporter
    container_name: node-exporter
    restart: always # Asegura que se reinicie si falla
    # Monta volúmenes para acceder a la información del sistema del host
    volumes:
      - /proc:/host/proc:ro # Acceso a información de procesos
      - /sys:/host/sys:ro # Acceso a información del sistema (CPU, etc.)
      - /:/rootfs:ro,rslave # Acceso al sistema de archivos raíz del host para métricas de disco
    command: | # Pasa argumentos al comando de inicio de Node Exporter
      --path.procfs=/host/proc
      --path.sysfs=/host/sys
      --collector.filesystem.mount-points-exclude="^/(sys|proc|dev|host|etc)($|/)" # Excluye puntos de montaje virtuales/no relevantes
    ports:
      - "9100:9100" # Puerto por defecto de Node Exporter - mapea 9100 del host al 9100 del contenedor
    networks:
      - monitoring-network # Asegúrate de que esté en la misma red que Prometheus
    pid: host # Permite al contenedor ver los procesos del host (necesario para algunas métricas)

# Define los volúmenes con nombre para la persistencia
volumes:
  prometheus_data:
  grafana_data:


networks:
  monitoring-network:
    driver: bridge # Usa el driver de red por defecto (puedes cambiarlo si es necesario)
